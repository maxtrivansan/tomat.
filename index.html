<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deteksi Tomat - AI Detection</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        text-align: center;
        padding: 40px 20px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        padding: 40px;
      }

      .upload-section {
        text-align: center;
        margin-bottom: 40px;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
      }

      .file-input {
        display: none;
      }

      .file-input-button {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      }

      .file-input-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
      }

      .url-input-section {
        margin: 20px 0;
      }

      .url-input {
        width: 100%;
        max-width: 500px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1em;
        margin-bottom: 15px;
        transition: border-color 0.3s ease;
      }

      .url-input:focus {
        outline: none;
        border-color: #4caf50;
      }

      .detect-button {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      }

      .detect-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      }

      .detect-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .image-display {
        text-align: center;
        margin: 30px 0;
      }

      .preview-image {
        max-width: 100%;
        max-height: 500px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        display: none;
      }

      .results-section {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        display: none;
      }

      .results-title {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.3em;
        text-align: center;
      }

      .detection-item {
        background: white;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .detection-class {
        font-weight: bold;
        color: #333;
        font-size: 1.1em;
      }

      .detection-confidence {
        background: #4caf50;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
      }

      .loading {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 5px solid #c62828;
        display: none;
      }

      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border-left: 5px solid #2e7d32;
        display: none;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2em;
        }

        .main-content {
          padding: 20px;
        }

        .url-input {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üçÖ Deteksi Tomat AI</h1>
        <p>
          Upload gambar atau masukkan URL untuk mendeteksi tomat menggunakan AI
        </p>
      </div>

      <div class="main-content">
        <div class="upload-section">
          <div class="file-input-wrapper">
            <input
              type="file"
              id="imageFile"
              class="file-input"
              accept="image/*"
            />
            <button
              class="file-input-button"
              onclick="document.getElementById('imageFile').click()"
            >
              üìÅ Pilih Gambar
            </button>
          </div>

          <div class="url-input-section">
            <p style="margin-bottom: 10px; color: #666; font-weight: bold">
              atau
            </p>
            <input
              type="url"
              id="imageUrl"
              class="url-input"
              placeholder="Masukkan URL gambar..."
            />
            <br />
            <button class="detect-button" onclick="detectFromUrl()">
              üîç Deteksi dari URL
            </button>
          </div>
        </div>

        <div class="image-display">
          <img id="previewImage" class="preview-image" alt="Preview" />
        </div>

        <div class="loading" id="loading">
          <div class="loading-spinner"></div>
          <p>Sedang menganalisis gambar...</p>
        </div>

        <div class="error" id="error"></div>
        <div class="success" id="success"></div>

        <div class="results-section" id="results">
          <h3 class="results-title">Hasil Deteksi:</h3>
          <div id="detectionResults"></div>
        </div>
      </div>
    </div>

    <script>
      const API_KEY = "q4UPgFhZpQTxmloM5WA9";
      const API_URL = "https://serverless.roboflow.com/tomato-oigp9/1";

      document
        .getElementById("imageFile")
        .addEventListener("change", handleFileSelect);

      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
          // Validate file type
          if (!file.type.startsWith("image/")) {
            showError("Mohon pilih file gambar yang valid (JPG, PNG, dll)");
            return;
          }

          // Validate file size (max 2MB for better processing)
          if (file.size > 2 * 1024 * 1024) {
            showError("Ukuran file terlalu besar. Maksimal 2MB");
            return;
          }

          // Try direct file upload first
          tryDirectFileUpload(file);
        }
      }

      async function tryDirectFileUpload(file) {
        showLoading();

        try {
          console.log("Trying direct file upload...");

          // Create FormData with the original file
          const formData = new FormData();
          formData.append("image", file);

          const response = await fetch(`${API_URL}?api_key=${API_KEY}`, {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const data = await response.json();
            displayResults(data);

            // Display the uploaded image
            const reader = new FileReader();
            reader.onload = function (e) {
              displayImage(e.target.result);
            };
            reader.readAsDataURL(file);

            return;
          } else {
            console.log(
              "Direct file upload failed, trying compressed version..."
            );
            // Fallback to compressed version
            const reader = new FileReader();
            reader.onload = function (e) {
              displayImage(e.target.result);
              resizeImageAndDetect(e.target.result);
            };
            reader.onerror = function () {
              showError("Gagal membaca file gambar");
            };
            reader.readAsDataURL(file);
          }
        } catch (error) {
          console.error("Direct file upload error:", error);
          // Fallback to base64 method
          const reader = new FileReader();
          reader.onload = function (e) {
            displayImage(e.target.result);
            resizeImageAndDetect(e.target.result);
          };
          reader.readAsDataURL(file);
        }
      }

      function resizeImageAndDetect(base64Image) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          // Resize if image is too large - use smaller max size
          let { width, height } = img;
          const maxSize = 800; // Reduced from 1024

          if (width > maxSize || height > maxSize) {
            const ratio = Math.min(maxSize / width, maxSize / height);
            width = Math.floor(width * ratio);
            height = Math.floor(height * ratio);
          }

          canvas.width = width;
          canvas.height = height;

          // Clear canvas and draw image
          ctx.clearRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0, width, height);

          // Convert to base64 with lower quality for smaller file size
          try {
            // Try different formats and qualities
            let resizedBase64;

            // First try JPEG with medium quality
            resizedBase64 = canvas.toDataURL("image/jpeg", 0.7);

            // If still too large, try lower quality
            const base64Length = resizedBase64.split(",")[1].length;
            console.log("Compressed image base64 length:", base64Length);

            if (base64Length > 50000) {
              // If larger than ~50KB
              console.log("Image still too large, reducing quality further...");
              resizedBase64 = canvas.toDataURL("image/jpeg", 0.5);
            }

            detectFromBase64(resizedBase64);
          } catch (error) {
            console.error("Canvas conversion error:", error);
            showError("Gagal memproses gambar. Coba dengan gambar lain.");
          }
        };

        img.onerror = function () {
          showError("Gagal memuat gambar. Pastikan format gambar valid.");
        };

        img.src = base64Image;
      }

      function displayImage(src) {
        const previewImage = document.getElementById("previewImage");
        previewImage.src = src;
        previewImage.style.display = "block";
      }

      function showLoading() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("results").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById("success").style.display = "none";
      }

      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        hideLoading();
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("success");
        successDiv.textContent = message;
        successDiv.style.display = "block";
      }

      // Utility function to validate base64
      function isValidBase64(str) {
        try {
          return btoa(atob(str)) === str;
        } catch (err) {
          return false;
        }
      }

      async function detectFromUrl() {
        const imageUrl = document.getElementById("imageUrl").value.trim();

        if (!imageUrl) {
          showError("Mohon masukkan URL gambar terlebih dahulu");
          return;
        }

        // Validate URL
        try {
          new URL(imageUrl);
        } catch {
          showError("URL tidak valid. Mohon masukkan URL yang benar");
          return;
        }

        displayImage(imageUrl);
        showLoading();

        try {
          // Method 1: Try with image URL directly
          const response = await fetch(`${API_URL}?api_key=${API_KEY}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image: imageUrl,
            }),
          });

          if (!response.ok) {
            // If URL method fails, try downloading and converting to base64
            if (response.status === 400) {
              console.log("URL method failed, trying base64 conversion...");
              await convertUrlToBase64AndDetect(imageUrl);
              return;
            }

            const errorText = await response.text();
            throw new Error(
              `HTTP error! status: ${response.status} - ${errorText}`
            );
          }

          const data = await response.json();
          displayResults(data);
        } catch (error) {
          console.error("Detection error:", error);
          showError(`Gagal melakukan deteksi: ${error.message}`);
        }
      }

      async function convertUrlToBase64AndDetect(imageUrl) {
        try {
          // Create a proxy URL to avoid CORS issues (you might need to implement this)
          const response = await fetch(imageUrl);
          const blob = await response.blob();

          const reader = new FileReader();
          reader.onload = function (e) {
            detectFromBase64(e.target.result);
          };
          reader.onerror = function () {
            showError("Gagal mengkonversi URL gambar ke base64");
          };
          reader.readAsDataURL(blob);
        } catch (error) {
          showError(
            "Gagal mengambil gambar dari URL. Pastikan URL dapat diakses."
          );
        }
      }

      async function detectFromBase64(base64Image) {
        showLoading();

        try {
          // Method 1: Try direct URL method (recommended by Roboflow)
          const success = await tryDirectImageMethod(base64Image);
          if (success) return;

          // Method 2: Try inference SDK simulation
          await tryInferenceMethod(base64Image);
        } catch (error) {
          console.error("Detection error:", error);
          showError(`Gagal melakukan deteksi: ${error.message}`);
        }
      }

      async function tryDirectImageMethod(base64Image) {
        try {
          // Convert base64 to blob and create object URL
          const blob = await base64ToBlob(base64Image);
          const imageUrl = URL.createObjectURL(blob);

          console.log("Trying direct image method with object URL...");

          const response = await fetch(`${API_URL}?api_key=${API_KEY}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              image: imageUrl,
            }),
          });

          // Clean up object URL
          URL.revokeObjectURL(imageUrl);

          if (response.ok) {
            const data = await response.json();
            displayResults(data);
            return true;
          } else {
            console.log(
              "Direct image method failed, trying inference method..."
            );
            return false;
          }
        } catch (error) {
          console.log("Direct image method error:", error.message);
          return false;
        }
      }

      async function tryInferenceMethod(base64Image) {
        try {
          // Convert base64 to raw binary and then back to clean base64
          const cleanBase64 = await getCleanBase64(base64Image);

          console.log("Trying inference method with clean base64...");
          console.log("Clean base64 length:", cleanBase64.length);
          console.log(
            "Clean base64 sample:",
            cleanBase64.substring(0, 50) + "..."
          );

          // Use different endpoint format similar to inference SDK
          const response = await fetch(
            `https://detect.roboflow.com/tomato-oigp9/1?api_key=${API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: cleanBase64, // Send raw base64 as body
            }
          );

          if (!response.ok) {
            // Try with JSON format
            const jsonResponse = await fetch(`${API_URL}?api_key=${API_KEY}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                image: {
                  type: "base64",
                  value: cleanBase64,
                },
              }),
            });

            if (!jsonResponse.ok) {
              const errorText = await jsonResponse.text();
              console.error("API Error Response:", errorText);
              throw new Error(
                "Kedua method gagal. Coba dengan gambar yang berbeda atau ukuran yang lebih kecil."
              );
            }

            const data = await jsonResponse.json();
            displayResults(data);
            return;
          }

          const data = await response.json();
          displayResults(data);
        } catch (error) {
          console.error("Inference method error:", error);
          throw new Error(`Gagal memproses gambar: ${error.message}`);
        }
      }

      // Helper function to get clean base64 without any headers
      async function getCleanBase64(base64Image) {
        return new Promise((resolve, reject) => {
          try {
            // Remove data URL prefix if present
            let base64Data = base64Image;
            if (base64Data.includes(",")) {
              base64Data = base64Data.split(",")[1];
            }

            // Clean any whitespace
            base64Data = base64Data.replace(/\s/g, "");

            // Validate and fix padding
            while (base64Data.length % 4 !== 0) {
              base64Data += "=";
            }

            // Test if base64 is valid by trying to decode it
            try {
              const binaryString = atob(base64Data);
              // If successful, re-encode to ensure it's clean
              const bytes = new Uint8Array(binaryString.length);
              for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
              }

              // Convert back to base64 to ensure it's properly formatted
              const cleanBase64 = btoa(String.fromCharCode.apply(null, bytes));
              resolve(cleanBase64);
            } catch (decodeError) {
              reject(new Error("Base64 data tidak valid"));
            }
          } catch (error) {
            reject(error);
          }
        });
      }

      // Helper function to convert base64 to blob
      function base64ToBlob(base64Image) {
        return new Promise((resolve, reject) => {
          try {
            // Remove data URL prefix if present
            let base64Data = base64Image;
            if (base64Data.includes(",")) {
              base64Data = base64Data.split(",")[1];
            }

            // Convert base64 to binary
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);

            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }

            // Create blob
            const blob = new Blob([bytes], { type: "image/jpeg" });
            resolve(blob);
          } catch (error) {
            reject(error);
          }
        });
      }

      function displayResults(data) {
        hideLoading();

        const resultsDiv = document.getElementById("results");
        const detectionResults = document.getElementById("detectionResults");

        if (!data.predictions || data.predictions.length === 0) {
          showSuccess(
            "Gambar berhasil dianalisis, namun tidak ada tomat yang terdeteksi"
          );
          return;
        }

        let resultsHTML = "";
        data.predictions.forEach((prediction, index) => {
          const confidence = Math.round(prediction.confidence * 100);
          const className = prediction.class || "Tomat";

          resultsHTML += `
      <div class="detection-item">
        <div>
          <div class="detection-class">${className}</div>
          <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
            Posisi: x=${Math.round(prediction.x)}, y=${Math.round(
            prediction.y
          )}<br>
            Ukuran: ${Math.round(prediction.width)}x${Math.round(
            prediction.height
          )}
          </div>
        </div>
        <div class="detection-confidence">${confidence}%</div>
      </div>
    `;
        });

        detectionResults.innerHTML = resultsHTML;
        resultsDiv.style.display = "block";

        showSuccess(
          `Berhasil mendeteksi ${data.predictions.length} tomat dalam gambar!`
        );
      }

      // Clear results when new image is selected
      document
        .getElementById("imageUrl")
        .addEventListener("input", function () {
          document.getElementById("results").style.display = "none";
          document.getElementById("error").style.display = "none";
          document.getElementById("success").style.display = "none";
        });
    </script>
  </body>
</html>
